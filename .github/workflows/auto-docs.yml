name: Automated Documentation Update

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'lib/**'
      - 'api/**'

jobs:
  generate-and-review-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better changelog
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        working-directory: ./cline-automation
        run: npm install
        
      - name: Run Cline Documentation Generator
        working-directory: ./cline-automation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node generate-docs.js .. ./generated-docs
          
      - name: Copy generated docs to docs-site
        run: |
          mkdir -p docs-site/pages/generated
          cp -r cline-automation/generated-docs/* docs-site/pages/generated/
          
      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ðŸ“š Update auto-generated documentation'
          title: 'ðŸ“š Automated Documentation Update - ${{ github.run_number }}'
          body: |
            ## ðŸ¤– Automated Documentation Update
            
            This PR contains automatically generated documentation updates created by **Cline CLI**.
            
            ### What's included:
            - âœ… Updated API documentation
            - âœ… Refreshed changelog
            - âœ… Architecture diagrams
            
            ### Review checklist:
            - [ ] API docs are accurate
            - [ ] Changelog is complete
            - [ ] Architecture reflects current state
            - [ ] No sensitive information exposed
            
            ### Generated by:
            - **Cline CLI** - Code analysis and doc generation
            - **GitHub Actions** - Automation workflow
            
            **CodeRabbit** will automatically review this PR for quality, completeness, and best practices.
            
            ---
            
            ðŸ¤– *This is an automated pull request. Please review carefully before merging.*
          branch: docs-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            documentation
            automated
            cline-generated
            
      - name: Enable CodeRabbit Review
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Request review from CodeRabbit
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.create-pr.outputs.pull-request-number }},
              reviewers: ['coderabbitai']
            });
            
            // Add comment to trigger CodeRabbit
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-pr.outputs.pull-request-number }},
              body: '@coderabbitai review'
            });
            
      - name: Output PR details
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "âœ… Pull Request created: #${{ steps.create-pr.outputs.pull-request-number }}"
          echo "ðŸ”— URL: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo "ðŸ¤– CodeRabbit review requested"
